#!/usr/bin/env bash

echo -ne "
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣶⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣰⡟⣷⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣰⡯⣝⠼⣧⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⡿⣱⢮⣙⠾⣇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⣿⢳⢱⡎⡎⣷⢹⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢼⡳⢎⡳⢎⣝⡲⢭⣻⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢭⡛⡼⣍⠶⣍⡳⣜⣻⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⡷⣄⡀⠪⣶⣩⠞⣥⠳⣎⢵⣻⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣰⢿⡱⢫⡝⡶⠄⠹⠿⣎⡳⢭⡲⢣⢿⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣰⢯⢧⣙⢧⣹⢚⡝⢦⠐⣲⢭⠳⣍⡏⣞⣻⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣴⠿⣩⠶⣩⢖⣣⢏⡞⡵⣚⠵⣪⢛⡴⡹⢆⡳⢿⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣴⣏⢻⠴⣫⠵⢮⡱⢞⡼⡱⡭⢞⣱⢫⣜⠳⣭⠳⣍⢿⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⡳⢎⡝⡮⣕⢫⠮⣕⣫⡶⠟⠷⢯⣜⣣⢞⣹⠲⡝⣎⡳⣻⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⡱⣍⠯⡼⣱⢎⣏⣳⡞⠁⠀⠀⠀⠀⠙⣾⣜⢲⢫⠵⣎⡵⢣⢿⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⢷⣱⢎⡹⡶⢇⡾⣆⡿⠀⠀⠀⠀⠀⠀⠀⠸⣇⡏⣇⠿⡰⣉⠏⣎⣹⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⣏⡳⡜⢮⠵⣍⡏⢶⣽⠇⠀⠀⠀⠀⠀⠀⠀⠀⢿⡜⣎⡳⡕⣤⡈⠊⡵⡻⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⡗⢮⣱⢫⡝⡺⣜⠼⣣⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣝⣲⡝⡼⣩⢟⣦⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⡻⣜⠳⣬⢓⡞⡵⣪⢝⣲⣿⡤⠀⠀⠀⠀⠀⠀⠀⠀⣼⣞⡴⡹⣜⢣⡞⢦⢫⢟⣦⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣾⢭⠳⣜⢫⢖⣫⣼⡵⠟⠛⠋⠉⠁⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⠙⠓⠯⢾⣼⣩⢳⣚⡴⢫⢷⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⡾⡝⢮⣝⡮⠟⠋⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⠓⠷⣮⣏⢮⢽⣆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣴⣟⡧⠟⠋⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠛⢮⣿⣆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠟⠁⠀⠀⠀⠀⠀⠀⠀⠀⣀⣀⣤⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⠀⠀⣠⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠛⢧⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⣿⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⠀⠀⠻⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⣠⣶⣶⣦⣶⣦⣄⠀⠀⣦⣶⡆⣠⣴⣶⡗⠀⣠⣴⣶⣶⣦⣤⠀⠀⣿⣿⡿⣤⣤⣤⣤⣄⡀⠀⠀⠀⣿⠀⠀⣰⠀⠀⣠⡀⠀⣠⣤⣤⣄⠀⠀⠀⣠⡄⠀⠀⠀⠀⠀⢠⡄⠀⣠⡀⠀⠀⠀⠀⣀⠀⠀
⠀⣰⡿⠿⠟⠿⢿⣿⣿⡄⠀⣽⣿⣿⣿⣿⠟⠀⣼⣿⣿⣿⣿⣿⣿⣿⠀⣿⣿⣿⣿⣿⡿⣿⣿⣿⣇⠀⠀⣿⠀⠀⣿⠀⠀⣿⣧⡶⠛⠛⠛⠿⣧⡀⠀⣿⡇⠀⠀⠀⠀⠀⢸⡇⠀⠻⣧⠀⠀⠀⣠⣿⠃⠀
⠀⣰⣶⣿⣿⣷⣶⣼⣿⡇⠀⢿⣿⡿⠁⠀⠀⣾⣿⡟⠁⠀⠀⠈⠛⠁⠀⣿⣿⣿⠀⠀⠀⠀⢻⣿⣿⠀⠀⣿⠀⠀⣿⠀⠀⣿⡏⠀⠀⠀⠀⠀⣿⡇⠀⣿⡇⠀⠀⠀⠀⠀⢸⡇⠀⠀⠙⢷⣄⣼⡿⠁⠀⠀
⣿⣿⡿⠋⠉⠉⢻⣿⣿⡇⠀⢿⣿⣗⠀⠀⠀⢻⣿⡄⠀⠀⠀⠀⠀⠀⠀⣿⣿⣿⠀⠀⠀⠀⣿⣿⣿⠀⠀⣿⠀⠀⣿⠀⠀⣿⡇⠀⠀⠀⠀⠀⣿⡇⠀⣿⡇⠀⠀⠀⠀⠀⢸⡇⠀⠀⠀⠀⣿⣯⠀⠀⠀⠀
⢿⣿⣷⣀⣀⣀⣼⣿⣿⡇⠀⣾⣿⣯⠀⠀⠀⢿⣿⣷⣄⣀⣀⣀⣴⣆⠀⣿⣿⣿⠀⠀⠀⠀⢽⣿⣿⠀⠀⣿⠀⠀⣿⠀⠀⣿⡇⠀⠀⠀⠀⠀⣿⡇⠀⣿⡇⠀⠀⠀⠀⠀⣾⡇⠀⠀⣴⡿⠃⠙⣷⡀⠀⠀
⠀⠻⣿⣿⣿⣿⡿⣫⣿⡇⠀⣿⣿⡷⠀⠀⠀⠀⠻⢿⣿⣿⣿⣿⡿⠋⠀⣿⣿⣿⠀⠀⠀⠀⣻⣿⣿⠀⠀⣿⠀⠀⣿⠀⠀⣿⡇⠀⠀⠀⠀⠀⣿⡇⠀⠙⣿⣦⣤⣤⣴⠟⢹⡇⠀⣼⡏⠀⠀⠀⠀⢿⡆⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀Auto Arch Linux Installer⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
"
#----------------------------Check boot mode------------------------------
BOOT_MODE=$(cat /sys/firmware/efi/fw_platform_size 2> /dev/null)
if [ ! $BOOT_MODE ]; then
    BOOT_MODE="BIOS/CSM"
else
    BOOT_MODE="UEFI"
fi

echo "Boot mode: $BOOT_MODE"

#-------------------Load configuration.conf config file--------------------
echo "[Loading configuration file]"
SCRIPT_DIR=$(dirname "$(readlink -f "$0")")
source ./configuration.conf

# Test if the desired mode is the correct one
if [ "$BOOT_MODE" != "$MODE" ]; then
    echo "SCRIPT IN BOOT MODE $MODE BUT PC IN $BOOT_MODE, CHANGING SCRIPT TO BOOT AS $BOOT_MODE!!"
    MODE=$BOOT_MODE
fi

echo "[Loading $KEYMAP keymap]"
loadkeys $KEYMAP
echo "[Setting $SETFONT font]"
setfont $SETFONT
echo "[Testing Internet Connection]"
if ping -c 1 ping.archlinux.org; then
    echo "Ping OK"
else
    echo "No Internet connection, Wireless auto connection not yet implemented"
fi
timedatectl
disks=$(lsblk | grep disk | tr -s ' ')
if lsblk | grep "vda"; then
    disk="/dev/$(ls /dev | grep vda)"
elif lsblk | grep "nvme0"; then
    disk="/dev/$(ls /dev | grep nvme0)"
elif lsblk | grep "sda"; then
    disk="/dev/$(ls /dev | grep sda)"
elif lsblk | grep "sdb"; then
    disk="/dev/$(ls /dev | grep sdb)"
fi
echo "[Detected drive: $disk]"
partition_count=0
# EFI Boot partition
if [ "$TABLE" == "GPT" ]; then
    (echo g; echo w) | fdisk $disk
fi

if [[ "$MODE" == "UEFI" && $BOOT_PARTITION_FLAG ]] ; then
    (echo n; echo; echo; echo ${BOOT_PARTITION[2]}; echo t; echo uefi; echo w) | fdisk $disk
    let partition_count++
    BOOT_PARTITION_COUNT=$partition_count
    echo "[Formatting Boot Partition $disk$partition_count]"
    ${BOOT_PARTITION[1]} $disk$partition_count
fi

# # Swap Partition
if [ $SWAP_PARTITION_FLAG ]; then
    (echo n; echo; echo; echo ${SWAP_PARTITION[2]}; echo t; echo; echo swap; echo w) | fdisk $disk
    let partition_count++
    SWAP_PARTITION_COUNT=$partition_count
    echo "[Formatting Swap Partition $disk$partition_count]"
    ${SWAP_PARTITION[1]} $disk$partition_count
fi
# Root Partition
if [ $ROOT_PARTITION_FLAG ]; then
    (echo n; echo; echo; echo ${ROOT_PARTITION[2]}; echo w) | fdisk $disk
    let partition_count++
    ROOT_PARTITION_COUNT=$partition_count
    echo "[Formatting Swap partition $disk$partition_count]"
    ${ROOT_PARTITION[1]} $disk$partition_count
fi

# Home Partition
if [ $HOME_PARTITION_FLAG ]; then
    (echo n; echo p; echo; echo; echo ${HOME_PARTITION[2]}; echo w) | fdisk $disk
    let partition_count++
    echo "[Formatting Home partition $disk$partition_count]"
    HOME_PARTITION_COUNT=$partition_count
    ${HOME_PARTITION[1]} $disk$partition_count
fi

echo "[Mounting Partitions...]"
if [ $ROOT_PARTITION_FLAG ]; then
    mount $disk$ROOT_PARTITION_COUNT /mnt
    echo "Root partition $disk$ROOT_PARTITION_COUNT mounted in /mnt"
fi

if [[ "$MODE" == "UEFI" && $BOOT_PARTITION_FLAG ]] ; then
    mount --mkdir $disk$BOOT_PARTITION_COUNT /mnt/boot
    echo "Boot partition $disk$BOOT_PARTITION_COUNT mounted in /mnt/boot"
fi

if [ $HOME_PARTITION_FLAG ]; then
    mount --mkdir $disk$HOME_PARTITION_COUNT /mnt/home
    echo "Home partition $disk$HOME_PARTITION_COUNT mounted in /mnt/home"
fi
if [ $SWAP_PARTITION_FLAG ]; then
    swapon $disk$SWAP_PARTITION_COUNT
    echo "Swap partition $disk$SWAP_PARTITION_COUNT in swapon"
fi
echo "[Installing base firmware and Network Manager]"
pacstrap -K /mnt base linux linux-firmware $NETWORKMGR ${PACKAGES[@]}
echo "[Configure the System]"

echo "Generating fstab..."
genfstab -U /mnt >> /mnt/etc/fstab

echo "Setting Timezone..."
arch-chroot /mnt ln -sf /usr/share/zoneinfo/$TIME /etc/localtime

echo "Synchronize clock..."
arch-chroot /mnt hwclock --systohc

echo "Generating Locales..."
arch-chroot /mnt locale-gen

echo "Setting console layout..."
echo "KEYMAP=$KEYMAP" > /mnt/etc/vconsole.conf

echo "Creating hostname..."
echo "$HOSTNAME" > /mnt/etc/hostname

echo "[Initramfs]"
echo "Launching mkinitcpio..."
arch-chroot /mnt mkinitcpio -P

echo "Creating user..."
arch-chroot /mnt useradd -m -G wheel -s /bin/bash $ADMIN_USERNAME
echo "Setting the password for user $ADMIN_USERNAME..."
arch-chroot /mnt passwd $ADMIN_USERNAME
echo "Adding wheel group to sudoers.."
echo "%wheel      ALL=(ALL:ALL) ALL" >> /mnt/etc/sudoers

# Could be a good idea to add different boot loaders
if [[ "$MODE" == "UEFI" && $BOOT_PARTITION_FLAG ]] ; then
    echo "Installing Grub..."
    arch-chroot /mnt pacman -Syu --noconfirm grub efibootmgr
    arch-chroot /mnt grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB
    arch-chroot /mnt grub-mkconfig -o /boot/grub/grub.cfg
fi

reboot
