#!/usr/bin/env bash

echo -ne "
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣶⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣰⡟⣷⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣰⡯⣝⠼⣧⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⡿⣱⢮⣙⠾⣇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⣿⢳⢱⡎⡎⣷⢹⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢼⡳⢎⡳⢎⣝⡲⢭⣻⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢭⡛⡼⣍⠶⣍⡳⣜⣻⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⡷⣄⡀⠪⣶⣩⠞⣥⠳⣎⢵⣻⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣰⢿⡱⢫⡝⡶⠄⠹⠿⣎⡳⢭⡲⢣⢿⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣰⢯⢧⣙⢧⣹⢚⡝⢦⠐⣲⢭⠳⣍⡏⣞⣻⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣴⠿⣩⠶⣩⢖⣣⢏⡞⡵⣚⠵⣪⢛⡴⡹⢆⡳⢿⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣴⣏⢻⠴⣫⠵⢮⡱⢞⡼⡱⡭⢞⣱⢫⣜⠳⣭⠳⣍⢿⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⡳⢎⡝⡮⣕⢫⠮⣕⣫⡶⠟⠷⢯⣜⣣⢞⣹⠲⡝⣎⡳⣻⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⡱⣍⠯⡼⣱⢎⣏⣳⡞⠁⠀⠀⠀⠀⠙⣾⣜⢲⢫⠵⣎⡵⢣⢿⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⢷⣱⢎⡹⡶⢇⡾⣆⡿⠀⠀⠀⠀⠀⠀⠀⠸⣇⡏⣇⠿⡰⣉⠏⣎⣹⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⣏⡳⡜⢮⠵⣍⡏⢶⣽⠇⠀⠀⠀⠀⠀⠀⠀⠀⢿⡜⣎⡳⡕⣤⡈⠊⡵⡻⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⡗⢮⣱⢫⡝⡺⣜⠼⣣⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣝⣲⡝⡼⣩⢟⣦⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⡻⣜⠳⣬⢓⡞⡵⣪⢝⣲⣿⡤⠀⠀⠀⠀⠀⠀⠀⠀⣼⣞⡴⡹⣜⢣⡞⢦⢫⢟⣦⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣾⢭⠳⣜⢫⢖⣫⣼⡵⠟⠛⠋⠉⠁⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⠙⠓⠯⢾⣼⣩⢳⣚⡴⢫⢷⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⡾⡝⢮⣝⡮⠟⠋⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⠓⠷⣮⣏⢮⢽⣆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣴⣟⡧⠟⠋⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠛⢮⣿⣆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠟⠁⠀⠀⠀⠀⠀⠀⠀⠀⣀⣀⣤⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⠀⠀⣠⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠛⢧⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⣿⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⠀⠀⠻⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⣠⣶⣶⣦⣶⣦⣄⠀⠀⣦⣶⡆⣠⣴⣶⡗⠀⣠⣴⣶⣶⣦⣤⠀⠀⣿⣿⡿⣤⣤⣤⣤⣄⡀⠀⠀⠀⣿⠀⠀⣰⠀⠀⣠⡀⠀⣠⣤⣤⣄⠀⠀⠀⣠⡄⠀⠀⠀⠀⠀⢠⡄⠀⣠⡀⠀⠀⠀⠀⣀⠀⠀
⠀⣰⡿⠿⠟⠿⢿⣿⣿⡄⠀⣽⣿⣿⣿⣿⠟⠀⣼⣿⣿⣿⣿⣿⣿⣿⠀⣿⣿⣿⣿⣿⡿⣿⣿⣿⣇⠀⠀⣿⠀⠀⣿⠀⠀⣿⣧⡶⠛⠛⠛⠿⣧⡀⠀⣿⡇⠀⠀⠀⠀⠀⢸⡇⠀⠻⣧⠀⠀⠀⣠⣿⠃⠀
⠀⣰⣶⣿⣿⣷⣶⣼⣿⡇⠀⢿⣿⡿⠁⠀⠀⣾⣿⡟⠁⠀⠀⠈⠛⠁⠀⣿⣿⣿⠀⠀⠀⠀⢻⣿⣿⠀⠀⣿⠀⠀⣿⠀⠀⣿⡏⠀⠀⠀⠀⠀⣿⡇⠀⣿⡇⠀⠀⠀⠀⠀⢸⡇⠀⠀⠙⢷⣄⣼⡿⠁⠀⠀
⣿⣿⡿⠋⠉⠉⢻⣿⣿⡇⠀⢿⣿⣗⠀⠀⠀⢻⣿⡄⠀⠀⠀⠀⠀⠀⠀⣿⣿⣿⠀⠀⠀⠀⣿⣿⣿⠀⠀⣿⠀⠀⣿⠀⠀⣿⡇⠀⠀⠀⠀⠀⣿⡇⠀⣿⡇⠀⠀⠀⠀⠀⢸⡇⠀⠀⠀⠀⣿⣯⠀⠀⠀⠀
⢿⣿⣷⣀⣀⣀⣼⣿⣿⡇⠀⣾⣿⣯⠀⠀⠀⢿⣿⣷⣄⣀⣀⣀⣴⣆⠀⣿⣿⣿⠀⠀⠀⠀⢽⣿⣿⠀⠀⣿⠀⠀⣿⠀⠀⣿⡇⠀⠀⠀⠀⠀⣿⡇⠀⣿⡇⠀⠀⠀⠀⠀⣾⡇⠀⠀⣴⡿⠃⠙⣷⡀⠀⠀
⠀⠻⣿⣿⣿⣿⡿⣫⣿⡇⠀⣿⣿⡷⠀⠀⠀⠀⠻⢿⣿⣿⣿⣿⡿⠋⠀⣿⣿⣿⠀⠀⠀⠀⣻⣿⣿⠀⠀⣿⠀⠀⣿⠀⠀⣿⡇⠀⠀⠀⠀⠀⣿⡇⠀⠙⣿⣦⣤⣤⣴⠟⢹⡇⠀⣼⡏⠀⠀⠀⠀⢿⡆⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀Auto Arch Linux Installer⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
"
#----------------------------Check boot mode------------------------------
BOOT_MODE=$(cat /sys/firmware/efi/fw_platform_size 2> /dev/null)
if [ ! $BOOT_MODE ]; then
    BOOT_MODE="BIOS/CSM"
else
    BOOT_MODE="UEFI"
fi

echo "Boot mode: $BOOT_MODE"

#-------------------Load configuration.conf config file--------------------
echo "[Loading configuration file]"
SCRIPT_DIR=$(dirname "$(readlink -f "$0")")
source ./configuration.conf

# Test if the desired mode is the correct one
if [ "$BOOT_MODE" != "$MODE" ]; then
    echo "SCRIPT IN BOOT MODE $MODE BUT PC IN $BOOT_MODE, CHANGING SCRIPT TO BOOT AS $BOOT_MODE!!"
    MODE=$BOOT_MODE
fi

echo "[Loading $KEYMAP keymap]"
loadkeys $KEYMAP
echo "[Setting $SETFONT font]"
setfont $SETFONT
echo "[Testing Internet Connection]"
if ping -c 1 ping.archlinux.org; then
    echo "Ping OK"
else
    echo "No Internet connection, Wireless auto connection not yet implemented"
fi
timedatectl
disks=$(lsblk | grep disk | tr -s ' ')
if lsblk | grep "vda"; then
    disk="/dev/$(ls /dev | grep vda)"
elif lsblk | grep "nvme0"; then
    disk="/dev/$(ls /dev | grep nvme0)"
elif lsblk | grep "sda"; then
    disk="/dev/$(ls /dev | grep sda)"
elif lsblk | grep "sdb"; then
    disk="/dev/$(ls /dev | grep sdb)"
fi
echo "[Detected drive: $disk]"
# EFI Boot partition
# Uses sgdisk, only works in UEFI, maybe sfdisk for non-UEFI partitions
if [[ "$MODE" == "UEFI" && $BOOT_PARTITION_FLAG ]] ; then
#    (echo n; echo; echo; echo ${BOOT_PARTITION[2]}; echo t; echo uefi; echo w) | fdisk $disk
    sgdisk -n 1::${BOOT_PARTITION[2]} -t 1:ef00 $disk
    echo "[Formatting Boot Partition $disk'1']"
    ${BOOT_PARTITION[1]} $disk'1'
fi

# # Swap Partition
if [ $SWAP_PARTITION_FLAG ]; then
#    (echo n; echo; echo; echo ${SWAP_PARTITION[2]}; echo t; echo; echo swap; echo w) | fdisk $disk
    sgdisk -n 2::${SWAP_PARTITION[2]} -t 2:8200 $disk
    echo "[Formatting Swap Partition $disk'2']"
    ${SWAP_PARTITION[1]} $disk'2'
fi
# Root Partition
if [ $ROOT_PARTITION_FLAG ]; then
#    (echo n; echo; echo; echo ${ROOT_PARTITION[2]}; echo w) | fdisk $disk
    sgdisk -n 3::${ROOT_PARTITION[2]} $disk
    echo "[Formatting Swap partition $disk'3']"
    ${ROOT_PARTITION[1]} $disk'3'
fi

# Home Partition
if [ $HOME_PARTITION_FLAG ]; then
#    (echo n; echo p; echo; echo; echo ${HOME_PARTITION[2]}; echo w) | fdisk $disk
    sgdisk -n 4::${HOME_PARTITION[2]} $disk
    echo "[Formatting Home partition $disk'4']"
    ${HOME_PARTITION[1]} $disk'4'
fi

echo "[Mounting Partitions...]"
if [ $ROOT_PARTITION_FLAG ]; then
    mount $disk'3' /mnt
    echo "Root partition $disk'3' mounted in /mnt"
fi

if [[ "$MODE" == "UEFI" && $BOOT_PARTITION_FLAG ]] ; then
    mount --mkdir $disk'1' /mnt/boot
    echo "Boot partition $disk'1' mounted in /mnt/boot"
fi

if [ $HOME_PARTITION_FLAG ]; then
    mount --mkdir $disk'4' /mnt/home
    echo "Home partition $disk'4' mounted in /mnt/home"
fi
if [ $SWAP_PARTITION_FLAG ]; then
    swapon $disk'2'
    echo "Swap partition $disk'2' in swapon"
fi

echo "Enabling parallel downloads in pacstrap..."
sed -i "s/#ParallelDownloads = 5/ParallelDownloads = 5/g" /etc/pacman.conf

echo "[Installing base firmware and Network Manager]"
pacstrap -K /mnt base linux linux-firmware $NETWORKMGR ${PACKAGES[@]}
echo "[Configure the System]"

echo "Generating fstab..."
genfstab -U /mnt >> /mnt/etc/fstab

if [ "$NETWORKMGR" == "networkmanager" ]; then
    echo "Enabling nmcli in systemd"
    arch-chroot /mnt systemctl enable NetworkManager
fi

echo "Setting Timezone..."
arch-chroot /mnt ln -sf /usr/share/zoneinfo/$TIME /etc/localtime

echo "Synchronize clock..."
arch-chroot /mnt hwclock --systohc

echo "Generating Locales..."
arch-chroot /mnt locale-gen

echo "Setting console layout..."
echo "KEYMAP=$KEYMAP" > /mnt/etc/vconsole.conf

echo "Creating hostname..."
echo "$HOSTNAME" > /mnt/etc/hostname

echo "[Initramfs]"
echo "Launching mkinitcpio..."
arch-chroot /mnt mkinitcpio -P

echo "Creating user..."
arch-chroot /mnt useradd -m -G wheel -s /bin/bash $ADMIN_USERNAME
echo "Setting the password for user $ADMIN_USERNAME..."
arch-chroot /mnt passwd $ADMIN_USERNAME
echo "Adding wheel group to sudoers.."
echo "%wheel      ALL=(ALL:ALL) ALL" >> /mnt/etc/sudoers

# Could be a good idea to add different boot loaders
if [[ "$MODE" == "UEFI" && $BOOT_PARTITION_FLAG ]] ; then
    echo "Installing Grub..."
    arch-chroot /mnt pacman -Syu --noconfirm grub efibootmgr
    arch-chroot /mnt grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB
    arch-chroot /mnt grub-mkconfig -o /boot/grub/grub.cfg
fi

reboot
